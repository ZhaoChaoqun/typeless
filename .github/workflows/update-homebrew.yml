name: Update Homebrew Cask

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag name (v1.2.2 -> 1.2.2)
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download release asset and calculate SHA256
        id: sha256
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/Nano-Typeless-${{ steps.version.outputs.version }}.zip"
          echo "Downloading from: $DOWNLOAD_URL"
          curl -L -o release.zip "$DOWNLOAD_URL"
          SHA256=$(sha256sum release.zip | cut -d ' ' -f 1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Calculated SHA256: $SHA256"

      - name: Checkout homebrew-typeless
        uses: actions/checkout@v4
        with:
          repository: ZhaoChaoqun/homebrew-typeless
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-typeless

      - name: Update Cask formula
        run: |
          cd homebrew-typeless

          # Update version and sha256 in the cask file
          sed -i 's/version "[^"]*"/version "${{ steps.version.outputs.version }}"/' Casks/nano-typeless.rb
          sed -i 's/sha256 "[^"]*"/sha256 "${{ steps.sha256.outputs.sha256 }}"/' Casks/nano-typeless.rb

          echo "Updated Cask file:"
          cat Casks/nano-typeless.rb

      - name: Commit and push changes
        run: |
          cd homebrew-typeless
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/nano-typeless.rb
          git commit -m "Bump nano-typeless to ${{ steps.version.outputs.version }}"
          git push
